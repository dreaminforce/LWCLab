<template>
  <div class="app-shell">
    <section class="pane pane--chat">
      <header class="pane__header">
        <h1 class="title">LWCLab</h1>
        <div class="model-toggle" role="group" aria-label="AI provider">
          <template for:each={modelProviderOptions} for:item="option">
            <button
              key={option.value}
              type="button"
              class={option.className}
              data-provider={option.value}
              onclick={handleModelToggle}>
              <span class="model-toggle__label">{option.label}</span>
            </button>
          </template>
        </div>
      </header>
      <div class="chat__history" role="log" aria-live="polite">
        <template if:true={hasMessages}>
          <template for:each={messages} for:item="message">
            <article key={message.id} class="chat__message" data-role={message.role}>
              <div class="chat__identity" data-role={message.role}>
                <div class="chat__avatar" data-role={message.role} aria-hidden="true">
                  <template if:true={message.isUser}>
                    <svg class="chat__avatar-icon" viewBox="0 0 24 24" aria-hidden="true">
                      <circle cx="12" cy="7.5" r="4"></circle>
                      <path d="M4 20c0-3.7 3.1-6.5 7-6.5h2c3.9 0 7 2.8 7 6.5v1H4z"></path>
                    </svg>
                  </template>
                  <template if:false={message.isUser}>
                    <svg class="chat__avatar-icon" viewBox="0 0 24 24" aria-hidden="true">
                      <rect x="4" y="6" width="16" height="12" rx="3"></rect>
                      <rect x="7" y="9" width="3" height="3" rx="1"></rect>
                      <rect x="14" y="9" width="3" height="3" rx="1"></rect>
                      <path d="M9 15h6" stroke-width="1.6" stroke-linecap="round" stroke="currentColor" fill="none"></path>
                      <path d="M9 4h6l1 2H8z"></path>
                    </svg>
                  </template>
                </div>
                <span class="chat__avatar-label">{message.label}</span>
              </div>
              <div class="chat__bubble">
                <p class="chat__text">{message.text}</p>
              </div>
            </article>
          </template>
        </template>
      </div>
      <div class="chat__composer">
        <label class="chat__label" for="prompt">Describe the component</label>
        <textarea
          id="prompt"
          class="chat__input"
          data-element-id="prompt-input"
          value={prompt}
          oninput={handleInput}
          placeholder="Describe the LWC you want (plain HTML only; no lightning-base-components)...">
        </textarea>
        <div class="chat__actions">
          <button
            type="button"
            class="chat__send"
            onclick={generate}
            disabled={isGenerateDisabled}>
            {buttonLabel}
          </button>
        </div>
      </div>
    </section>

    <section class="pane pane--preview">
      <div class="preview__header">
        <div>
          <h2 class="pane__title">Preview &amp; Code</h2>
          <p class="pane__subtitle">Review the generated UI or inspect the source.</p>
        </div>
        <div class="preview__actions">
          <div class="view-toggle">
            <button data-tab="preview" type="button" onclick={setTab} class={previewBtnClass}>Preview</button>
            <button data-tab="code" type="button" onclick={setTab} class={codeBtnClass}>Code</button>
          </div>
          <button
            type="button"
            class="preview__refresh"
            onclick={refreshPreview}
            disabled={isRefreshDisabled}>
            {refreshButtonLabel}
          </button>
          <button
            type="button"
            class="preview__export"
            onclick={exportCode}
            disabled={isExportDisabled}>
            {exportButtonLabel}
          </button>
          <button
            type="button"
            class="preview__deploy"
            onclick={openDeployModal}
            disabled={isDeployDisabled}>
            {deployButtonLabel}
          </button>
        </div>
      </div>

      <div class="preview__body">
        <template if:true={generating}>
          <div class="preview__progress" role="status" aria-live="polite">
            <div class="preview__progress-bar">
              <div class="preview__progress-fill"></div>
            </div>
            <span class="preview__progress-text">Generating component...</span>
          </div>
        </template>
        <template if:true={isPreview}>
          <template if:true={hasGenerated}>
            <gen-preview></gen-preview>
          </template>
          <template if:false={hasGenerated}>
            <div class="preview__placeholder">
              Start Building..
            </div>
          </template>
        </template>

        <template if:true={isCode}>
          <template if:true={hasCode}>
            <div class="code-view">
              <div class="code-view__file">
                <div class="code-view__header">
                  <h3 class="code-view__title">preview.html</h3>
                  <button
                    type="button"
                    class="code-view__copy"
                    data-target="html"
                    onclick={copyCode}
                    title="Copy preview.html"
                    aria-label="Copy preview.html to clipboard">
                    <svg class="code-view__copy-icon" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M9 3h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"></path>
                      <path d="M7 7H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-2" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"></path>
                    </svg>
                    <span class="visually-hidden">Copy preview.html</span>
                  </button>
                </div>
                <textarea
                  class="code-view__editor"
                  data-target="html"
                  value={codeHtml}
                  oninput={handleCodeInput}
                  spellcheck="false"
                  wrap="off"
                  autocapitalize="off"
                  autocomplete="off"
                  autocorrect="off"
                  aria-label="Edit preview.html"
                  rows="18"></textarea>
              </div>
              <div class="code-view__file">
                <div class="code-view__header">
                  <h3 class="code-view__title">preview.js</h3>
                  <button
                    type="button"
                    class="code-view__copy"
                    data-target="js"
                    onclick={copyCode}
                    title="Copy preview.js"
                    aria-label="Copy preview.js to clipboard">
                    <svg class="code-view__copy-icon" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M9 3h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"></path>
                      <path d="M7 7H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-2" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"></path>
                    </svg>
                    <span class="visually-hidden">Copy preview.js</span>
                  </button>
                </div>
                <textarea
                  class="code-view__editor"
                  data-target="js"
                  value={codeJs}
                  oninput={handleCodeInput}
                  spellcheck="false"
                  wrap="off"
                  autocapitalize="off"
                  autocomplete="off"
                  autocorrect="off"
                  aria-label="Edit preview.js"
                  rows="18"></textarea>
              </div>
              <div class="code-view__file">
                <div class="code-view__header">
                  <h3 class="code-view__title">preview.css</h3>
                  <button
                    type="button"
                    class="code-view__copy"
                    data-target="css"
                    onclick={copyCode}
                    title="Copy preview.css"
                    aria-label="Copy preview.css to clipboard">
                    <svg class="code-view__copy-icon" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M9 3h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"></path>
                      <path d="M7 7H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-2" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"></path>
                    </svg>
                    <span class="visually-hidden">Copy preview.css</span>
                  </button>
                </div>
                <textarea
                  class="code-view__editor"
                  data-target="css"
                  value={codeCss}
                  oninput={handleCodeInput}
                  spellcheck="false"
                  wrap="off"
                  autocapitalize="off"
                  autocomplete="off"
                  autocorrect="off"
                  aria-label="Edit preview.css"
                  rows="18"></textarea>
              </div>
            </div>
          </template>
          <template if:false={hasCode}>
            <div class="preview__placeholder">
              Code will appear here after you generate a component.
            </div>
          </template>
        </template>
      </div>
    </section>
  <template if:true={showDeployModal}>
    <div class="deploy-modal">
      <div class="deploy-modal__backdrop" onclick={handleDeployBackdropClick}></div>
      <div class="deploy-modal__panel" role="dialog" aria-modal="true" aria-labelledby="deploy-modal-title">
        <h3 class="deploy-modal__title" id="deploy-modal-title">Deploy to Salesforce</h3>
        <p class="deploy-modal__subtitle">Enter your Salesforce credentials to deploy the current component.</p>
        <form class="deploy-modal__form" onsubmit={submitDeployment}>
          <div class="deploy-modal__field">
            <label class="deploy-modal__label" for="deploy-bundle">Component Name</label>
            <input
              id="deploy-bundle"
              class="deploy-modal__input"
              type="text"
              data-field="bundle"
              value={deployBundleName}
              oninput={handleDeployInput}
              autocomplete="off"
              placeholder="MyComponent"
              pattern="[A-Za-z][A-Za-z0-9_]*"
              required
              autofocus
              spellcheck="false"
            />
            <p class="deploy-modal__hint">Letters, numbers, and underscores only. Must start with a  small letter.</p>
          </div>
          <div class="deploy-modal__field">
            <span class="deploy-modal__label">Expose On</span>
            <div class="deploy-modal__targets">
              <template for:each={deployTargetOptions} for:item="option">
                <label key={option.value} class="deploy-target">
                  <input
                    type="checkbox"
                    class="deploy-target__input"
                    value={option.value}
                    checked={option.selected}
                    onchange={toggleDeployTarget}
                  />
                  <div class="deploy-target__details">
                    <span class="deploy-target__label">{option.label}</span>
                    <span class="deploy-target__description">{option.description}</span>
                  </div>
                </label>
              </template>
            </div>
            <p class="deploy-modal__hint">Select at least one Lightning Experience surface.</p>
          </div>
          <div class="deploy-modal__field">
            <label class="deploy-modal__label" for="deploy-username">Username</label>
            <input
              id="deploy-username"
              class="deploy-modal__input"
              type="text"
              data-field="username"
              value={deployUsername}
              oninput={handleDeployInput}
              autocomplete="username"
              placeholder="name@example.com"
              required
            />
          </div>
          <div class="deploy-modal__field">
            <label class="deploy-modal__label" for="deploy-password">Password</label>
            <input
              id="deploy-password"
              class="deploy-modal__input"
              type="password"
              data-field="password"
              value={deployPassword}
              oninput={handleDeployInput}
              autocomplete="current-password"
              placeholder="Your Salesforce password"
              required
            />
            <p class="deploy-modal__hint">Append your security token to the password if your org requires one.</p>
          </div>
          <template if:true={deployError}>
            <div class="deploy-modal__error" role="alert">{deployError}</div>
          </template>
          <div class="deploy-modal__actions">
            <button
              type="button"
              class="deploy-modal__cancel"
              onclick={closeDeployModal}
              disabled={deploying}>
              Cancel
            </button>
            <button
              type="submit"
              class="deploy-modal__submit"
              disabled={deploySubmitDisabled}>
              <template if:true={deploying}>Deploying...</template>
              <template if:false={deploying}>Deploy</template>
            </button>
          </div>
        </form>
      </div>
    </div>
  </template>
  </div>
</template>

